# HD Wallet EVM 多链钱包系统

一个基于 [go-starter](https://github.com/allaboutapps/go-starter) 框架开发的企业级分层确定性钱包（HD Wallet）系统，专为 EVM 兼容链设计，适用于交易所、托管钱包等需要安全密钥管理和多链资产管理的场景。

## 📋 项目简介

HD Wallet EVM 多链钱包系统是一个完整的托管钱包解决方案，采用单一助记词 + keystore 加密存储的设计，支持多个 EVM 兼容链（以太坊主网、Polygon、BSC、Arbitrum、Optimism、Avalanche、Base 等）。系统严格遵循零私钥存储原则，所有用户私钥按需派生，使用后立即清除，确保最高级别的安全性。

### 核心设计原则

1. **单一种子源**：系统只保存一个加密的助记词（keystore），所有用户地址都从此派生
2. **启动时解锁**：服务启动时输入密码，解密助记词并生成种子，种子保存在内存中
3. **零私钥存储**：用户私钥不保存，需要签名时从种子+路径临时计算
4. **即时清除**：私钥使用后立即从内存清除，不持久化
5. **元数据存储**：数据库只保存地址、路径等元数据，不保存私钥

## ✨ 核心特性

### 🔐 安全性
- **Keystore 加密存储**：使用标准 keystore 格式加密存储单一助记词
- **零私钥持久化**：私钥仅在内存中临时存在，使用后立即清除
- **密码保护**：启动时密码解锁，支持交互式或环境变量配置
- **内存安全**：敏感数据使用后立即清除，防止内存泄露

### 🌐 多链支持
- **EVM 兼容链**：支持以太坊主网、Polygon、BSC、Arbitrum、Optimism、Avalanche、Base 等
- **统一索引空间**：所有 EVM 链共享地址索引，简化管理
- **链配置管理**：支持动态添加和管理新链配置
- **多链并发扫描**：支持多链并发区块扫描和交易检测

### 💼 完整功能
- **钱包管理**：创建钱包、地址生成、地址查询
- **充值处理**：多链区块扫描、交易检测、确认机制、自动入账
- **提现处理**：完整提现流程、热钱包管理、管理员审核、状态自动更新
- **资金归集**：用户钱包到热钱包的自动/手动归集，支持 ERC20 和 Native Token
- **资金调度**：热钱包之间的资金调度，支持阈值触发和手动触发
- **余额管理**：基于 Credits 流水表的余额查询和聚合

### 🏗️ 架构设计
- **分层架构**：严格遵循 go-starter 的分层架构模式
- **依赖注入**：使用 Wire 进行依赖注入，代码解耦
- **ORM 支持**：使用 SQLBoiler 自动生成数据库模型
- **API 优先**：Swagger-First 开发模式，自动生成类型定义

## 🎯 使用场景

### 交易所钱包系统
- **用户充值**：自动检测用户充值交易，支持多链并发处理
- **用户提现**：完整的提现流程，包括管理员审核、热钱包选择、交易签名
- **资金管理**：自动归集用户资金到热钱包，热钱包间资金调度
- **余额查询**：实时余额查询，支持多链、多币种

### 托管钱包服务
- **多用户管理**：每个用户独立的钱包地址，统一由系统管理
- **安全存储**：零私钥存储设计，最大程度保护用户资产安全
- **多链资产管理**：统一管理多个 EVM 链上的资产
- **审计追踪**：完整的交易记录和余额流水，便于审计

### 企业级应用
- **高可用性**：支持多 RPC 节点故障转移
- **可扩展性**：模块化设计，易于扩展新功能
- **可维护性**：清晰的代码结构和完整的文档
- **安全性**：企业级安全设计，符合行业最佳实践

## 🚀 实现功能

### 阶段一：基础架构 ✅
- ✅ 数据库设计和迁移（多链支持）
- ✅ Keystore 加密/解密服务
- ✅ 种子管理器（内存管理）
- ✅ 地址生成服务（BIP44 标准）
- ✅ 交易签名服务（EIP-1559）
- ✅ 基础 API（创建钱包、查询地址、签名交易）

### 阶段二：充值模块 ✅
- ✅ 多链区块扫描服务
- ✅ 交易检测和分析
- ✅ 确认机制（confirmed → safe → finalized）
- ✅ 充值处理服务
- ✅ 区块重组（Reorg）检测和处理
- ✅ 充值 API

### 阶段三：提现模块 ✅
- ✅ 热钱包管理服务
- ✅ 热钱包创建 API（管理员权限）
- ✅ 提现服务（余额检查、费用计算、交易签名）
- ✅ 管理员审核流程（批准/拒绝）
- ✅ 提现状态自动更新（pending → processing → confirmed）
- ✅ 提现 API（发起、查询、批准、拒绝）

### 阶段四：余额管理 ✅
- ✅ 余额服务（基于 Credits 表）
- ✅ 可用余额计算（扣除冻结资金）
- ✅ 余额查询 API

### 阶段五：归集和调度 ✅
- ✅ 归集服务（自动/手动触发）
- ✅ ERC20 归集时的 Gas 充值逻辑
- ✅ 归集顺序优化（先 ERC20，后 Native Token）
- ✅ 资金调度服务（热钱包间调度）
- ✅ 归集和调度 API
- ✅ 全局配置管理（自动归集、自动调度、签名功能开关）

### 阶段六：优化和测试 ⏳
- ⏳ 性能优化
- ⏳ 安全增强
- ⏳ 完整测试
- ⏳ 文档完善

## 🏛️ 技术架构

### 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                    HTTP API Layer                            │
│  (Echo Framework - internal/api/handlers/wallet/)           │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                  Service Layer                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Wallet       │  │ Scan         │  │ Withdraw      │      │
│  │ Service      │  │ Service      │  │ Service      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Collect      │  │ Rebalance    │  │ Balance      │      │
│  │ Service      │  │ Service      │  │ Service      │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│                  Model Layer                                 │
│  (SQLBoiler Generated - internal/models/)                    │
└───────────────────────┬─────────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────────┐
│              Persistence Layer                               │
│  (PostgreSQL Database)                                      │
└─────────────────────────────────────────────────────────────┘
```

### 核心技术栈

- **框架**：go-starter（基于 Echo 框架）
- **数据库**：PostgreSQL
- **ORM**：SQLBoiler
- **依赖注入**：Google Wire
- **API 文档**：Swagger/OpenAPI
- **区块链交互**：go-ethereum
- **加密**：BIP39（助记词）、BIP32/BIP44（HD 钱包）、Scrypt（keystore 加密）

## 📚 文档

### 设计文档
- **[HD Wallet 设计方案](./docs/hd-wallet-design.md)**：详细的设计文档，包括架构设计、数据库设计、核心功能设计等

### 开发计划
- **[开发计划文档](./docs/development-plan.md)**：完整的开发计划和进度跟踪，包括各阶段任务和完成情况

### 其他文档
- **[服务器初始化文档](./docs/server-initialization.md)**：服务器启动和初始化流程说明
- **[阶段二完成总结](./docs/phase2-completion-summary.md)**：充值模块开发完成总结

## 🛠️ 快速开始

### 前置要求

- Go 1.21+
- PostgreSQL 14+
- 支持 EVM 的 RPC 节点（如 Infura、Alchemy 等）

### 环境配置

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd go-wallet
   ```

2. **配置环境变量**
   ```bash
   # 数据库配置
   export DATABASE_URL=postgres://user:password@localhost:5432/wallet?sslmode=disable
   
   # 钱包配置
   export WALLET_ENABLE_AUTO_COLLECT=false  # 是否启用自动归集
   export WALLET_ENABLE_AUTO_REBALANCE=false # 是否启用自动调度
   export WALLET_ENABLE_SIGNING=false       # 是否启用签名功能
   
   # RPC 节点配置（示例）
   export ETH_RPC_URLS=https://mainnet.infura.io/v3/YOUR_PROJECT_ID
   export BSC_RPC_URLS=https://bsc-dataseed.binance.org
   ```

3. **运行数据库迁移**
   ```bash
   make sql-reset  # 重置开发数据库
   make sql        # 生成数据库模型
   ```

4. **生成 API 类型**
   ```bash
   make swagger    # 生成 Swagger 类型定义
   ```

5. **启动服务**
   ```bash
   make build      # 构建项目
   ./bin/server    # 启动服务器
   ```

   首次启动时会提示输入密码来解锁 keystore。

## 🔧 开发规范

本项目严格遵循 go-starter 的开发规范，详细规范请参考：

- **[项目开发规范](.cursorrules)**：完整的开发规范文档，包括架构规范、编码规范、API 规范等

### 关键规范要点

- **Swagger-First**：API 开发必须先定义 Swagger 规范，再生成代码
- **Wire 依赖注入**：所有服务必须使用 Wire 进行依赖注入
- **分层架构**：严格遵循 API → Service → Model → Persistence 的分层
- **错误处理**：使用 `errors.Wrap` 添加上下文，不忽略错误
- **日志规范**：使用 zerolog 进行结构化日志记录，不记录敏感信息

## 📊 项目状态

### 当前进度

- **阶段一：基础架构** - ✅ 100% 完成
- **阶段二：充值模块** - ✅ 100% 完成
- **阶段三：提现模块** - ✅ 95% 完成（剩余部分测试）
- **阶段四：余额管理** - ✅ 90% 完成（剩余历史查询）
- **阶段五：归集和调度** - ✅ 100% 完成
- **阶段六：优化和测试** - ⏳ 进行中

**总体完成度：约 85%**

### 最新功能亮点

- ✅ **管理员审核流程**：提现请求需要管理员批准后才能处理
- ✅ **状态自动更新**：提现状态根据交易确认数自动更新
- ✅ **Gas 管理**：ERC20 归集时自动检查并充值 Native Token 作为 Gas
- ✅ **归集顺序优化**：先归集 ERC20，再归集 Native Token，提高 Gas 效率
- ✅ **全局配置**：支持通过环境变量控制自动归集和签名功能

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

[待定]

---

**最后更新**：2025-11-25  
**当前阶段**：阶段六 - 优化和测试
